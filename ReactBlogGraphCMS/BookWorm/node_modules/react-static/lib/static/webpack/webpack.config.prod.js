"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = _default;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _webpack = _interopRequireDefault(require("webpack"));

var _path = _interopRequireDefault(require("path"));

var _caseSensitivePathsWebpackPlugin = _interopRequireDefault(require("case-sensitive-paths-webpack-plugin"));

var _webpackBundleAnalyzer = require("webpack-bundle-analyzer");

var _terserWebpackPlugin = _interopRequireDefault(require("terser-webpack-plugin"));

var _webpackNodeExternals = _interopRequireDefault(require("webpack-node-externals"));

var _extractCssChunksWebpackPlugin = _interopRequireDefault(require("extract-css-chunks-webpack-plugin"));

var _optimizeCssAssetsWebpackPlugin = _interopRequireDefault(require("optimize-css-assets-webpack-plugin"));

var _resolveFrom = _interopRequireDefault(require("resolve-from"));

var _rules = _interopRequireDefault(require("./rules"));

//
function common(state) {
  var analyze = state.analyze,
      config = state.config,
      debug = state.debug;
  var _config$paths = config.paths,
      ROOT = _config$paths.ROOT,
      DIST = _config$paths.DIST,
      NODE_MODULES = _config$paths.NODE_MODULES,
      SRC = _config$paths.SRC,
      ASSETS = _config$paths.ASSETS;
  process.env.REACT_STATIC_ENTRY_PATH = config.entry;
  process.env.REACT_STATIC_SITE_ROOT = config.siteRoot;
  process.env.REACT_STATIC_BASE_PATH = config.basePath;
  process.env.REACT_STATIC_PUBLIC_PATH = config.publicPath;
  process.env.REACT_STATIC_ASSETS_PATH = config.assetsPath;

  if (!DIST.startsWith(ROOT)) {
    // we build outside of project dir, so reset some paths
    process.env.REACT_STATIC_ASSETS_PATH = config.assetsPath.replace(DIST, '');
  }

  var splitChunks = {
    chunks: 'all',
    minSize: 10000,
    minChunks: 1,
    maxAsyncRequests: 5,
    maxInitialRequests: 5,
    automaticNameDelimiter: '~',
    name: true,
    cacheGroups: {
      vendors: {
        test: /[\\/]node_modules[\\/]/,
        priority: -10,
        chunks: 'all'
      },
      "default": {
        minChunks: 2,
        priority: -20,
        reuseExistingChunk: true
      }
    }
  };
  var extrackCSSChunks = new _extractCssChunksWebpackPlugin["default"]({
    filename: '[name].[chunkHash:8].css',
    chunkFilename: '[id].[chunkHash:8].css'
  });

  if (!config.extractCssChunks) {
    splitChunks.cacheGroups = {
      styles: {
        name: 'styles',
        test: /\.css$/,
        chunks: 'all',
        enforce: true
      }
    };
    extrackCSSChunks = new _extractCssChunksWebpackPlugin["default"]({
      filename: '[name].[chunkHash:8].css'
    });
  }

  return {
    mode: 'production',
    context: _path["default"].resolve(__dirname, '../../../node_modules'),
    entry: config.disableRuntime ? config.entry : [require.resolve('../../bootstrapPlugins'), require.resolve('../../bootstrapTemplates'), require.resolve('../../bootstrapApp')],
    output: {
      filename: '[name].[hash:8].js',
      // dont use chunkhash, its not a chunk
      chunkFilename: 'templates/[name].[chunkHash:8].js',
      path: ASSETS,
      publicPath: process.env.REACT_STATIC_ASSETS_PATH || '/'
    },
    optimization: {
      sideEffects: true,
      minimize: true,
      minimizer: [new _terserWebpackPlugin["default"]((0, _objectSpread2["default"])({
        cache: true,
        parallel: true,
        exclude: /\.min\.js/
      }, config.terser, {
        sourceMap: config.productionSourceMaps || config.terser.sourceMap || debug,
        terserOptions: (0, _objectSpread2["default"])({
          ie8: false
        }, config.terser.terserOptions, {
          mangle: (0, _objectSpread2["default"])({
            safari10: true
          }, config.terser.terserOptions.mangle),
          parse: (0, _objectSpread2["default"])({
            ecma: 8
          }, config.terser.terserOptions.parse),
          compress: (0, _objectSpread2["default"])({
            ecma: 5
          }, config.terser.terserOptions.compress),
          output: (0, _objectSpread2["default"])({
            ecma: 5
          }, config.terser.terserOptions.output)
        })
      })), new _optimizeCssAssetsWebpackPlugin["default"]({})],
      splitChunks: splitChunks
    },
    performance: {
      maxEntrypointSize: 300000
    },
    module: {
      rules: (0, _rules["default"])({
        config: config,
        stage: 'prod',
        isNode: false
      }),
      strictExportPresence: true
    },
    resolve: {
      modules: [NODE_MODULES, SRC, DIST].concat((0, _toConsumableArray2["default"])([NODE_MODULES, SRC, DIST].map(function (d) {
        return DIST.startsWith(ROOT) ? _path["default"].relative(__dirname, d) : _path["default"].resolve(d);
      })), ['node_modules']),
      extensions: ['.wasm', '.mjs', '.js', '.json', '.jsx'],
      alias: {
        react: (0, _resolveFrom["default"])(config.paths.NODE_MODULES, 'react'),
        'react-dom': (0, _resolveFrom["default"])(config.paths.NODE_MODULES, 'react-dom'),
        'react-universal-component': (0, _resolveFrom["default"])(__dirname, 'react-universal-component')
      }
    },
    externals: [],
    target: undefined,
    plugins: [new _webpack["default"].EnvironmentPlugin(process.env), extrackCSSChunks, new _caseSensitivePathsWebpackPlugin["default"](), analyze && new _webpackBundleAnalyzer.BundleAnalyzerPlugin()].filter(function (d) {
      return d;
    }),
    devtool: debug || config.productionSourceMaps ? 'source-map' : false
  };
}

function _default(state) {
  var stage = state.stage,
      paths = state.config.paths;
  var result = common(state);
  if (stage !== 'node') return result; // Node only!!!

  result.output.filename = 'static-app.js';
  result.output.path = paths.ARTIFACTS;
  result.output.libraryTarget = 'umd';
  result.optimization.minimize = false;
  result.optimization.minimizer = [];
  result.target = 'node';
  result.devtool = false;
  result.externals = [new RegExp("".concat(paths.PLUGINS)), function (context, request, callback) {
    var resolved = _path["default"].resolve(context, request);

    if ([/react-static(\\|\/)lib(\\|\/)browser/, /webpack-flush-chunks/].some(function (d) {
      return d.test(resolved);
    })) {
      return callback(null, "commonjs ".concat(resolved));
    }

    callback();
  }, (0, _webpackNodeExternals["default"])()];
  result.module.rules = (0, _rules["default"])(state);
  result.plugins = [new _webpack["default"].EnvironmentPlugin(process.env), new _caseSensitivePathsWebpackPlugin["default"](), new _webpack["default"].optimize.LimitChunkCountPlugin({
    maxChunks: 1
  })];
  return result;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zdGF0aWMvd2VicGFjay93ZWJwYWNrLmNvbmZpZy5wcm9kLmpzIl0sIm5hbWVzIjpbImNvbW1vbiIsInN0YXRlIiwiYW5hbHl6ZSIsImNvbmZpZyIsImRlYnVnIiwicGF0aHMiLCJST09UIiwiRElTVCIsIk5PREVfTU9EVUxFUyIsIlNSQyIsIkFTU0VUUyIsInByb2Nlc3MiLCJlbnYiLCJSRUFDVF9TVEFUSUNfRU5UUllfUEFUSCIsImVudHJ5IiwiUkVBQ1RfU1RBVElDX1NJVEVfUk9PVCIsInNpdGVSb290IiwiUkVBQ1RfU1RBVElDX0JBU0VfUEFUSCIsImJhc2VQYXRoIiwiUkVBQ1RfU1RBVElDX1BVQkxJQ19QQVRIIiwicHVibGljUGF0aCIsIlJFQUNUX1NUQVRJQ19BU1NFVFNfUEFUSCIsImFzc2V0c1BhdGgiLCJzdGFydHNXaXRoIiwicmVwbGFjZSIsInNwbGl0Q2h1bmtzIiwiY2h1bmtzIiwibWluU2l6ZSIsIm1pbkNodW5rcyIsIm1heEFzeW5jUmVxdWVzdHMiLCJtYXhJbml0aWFsUmVxdWVzdHMiLCJhdXRvbWF0aWNOYW1lRGVsaW1pdGVyIiwibmFtZSIsImNhY2hlR3JvdXBzIiwidmVuZG9ycyIsInRlc3QiLCJwcmlvcml0eSIsInJldXNlRXhpc3RpbmdDaHVuayIsImV4dHJhY2tDU1NDaHVua3MiLCJFeHRyYWN0Q3NzQ2h1bmtzIiwiZmlsZW5hbWUiLCJjaHVua0ZpbGVuYW1lIiwiZXh0cmFjdENzc0NodW5rcyIsInN0eWxlcyIsImVuZm9yY2UiLCJtb2RlIiwiY29udGV4dCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZGlzYWJsZVJ1bnRpbWUiLCJyZXF1aXJlIiwib3V0cHV0Iiwib3B0aW1pemF0aW9uIiwic2lkZUVmZmVjdHMiLCJtaW5pbWl6ZSIsIm1pbmltaXplciIsIlRlcnNlclBsdWdpbiIsImNhY2hlIiwicGFyYWxsZWwiLCJleGNsdWRlIiwidGVyc2VyIiwic291cmNlTWFwIiwicHJvZHVjdGlvblNvdXJjZU1hcHMiLCJ0ZXJzZXJPcHRpb25zIiwiaWU4IiwibWFuZ2xlIiwic2FmYXJpMTAiLCJwYXJzZSIsImVjbWEiLCJjb21wcmVzcyIsIk9wdGltaXplQ1NTQXNzZXRzUGx1Z2luIiwicGVyZm9ybWFuY2UiLCJtYXhFbnRyeXBvaW50U2l6ZSIsIm1vZHVsZSIsInJ1bGVzIiwic3RhZ2UiLCJpc05vZGUiLCJzdHJpY3RFeHBvcnRQcmVzZW5jZSIsIm1vZHVsZXMiLCJtYXAiLCJkIiwicmVsYXRpdmUiLCJleHRlbnNpb25zIiwiYWxpYXMiLCJyZWFjdCIsImV4dGVybmFscyIsInRhcmdldCIsInVuZGVmaW5lZCIsInBsdWdpbnMiLCJ3ZWJwYWNrIiwiRW52aXJvbm1lbnRQbHVnaW4iLCJDYXNlU2Vuc2l0aXZlUGF0aHNQbHVnaW4iLCJCdW5kbGVBbmFseXplclBsdWdpbiIsImZpbHRlciIsImRldnRvb2wiLCJyZXN1bHQiLCJBUlRJRkFDVFMiLCJsaWJyYXJ5VGFyZ2V0IiwiUmVnRXhwIiwiUExVR0lOUyIsInJlcXVlc3QiLCJjYWxsYmFjayIsInJlc29sdmVkIiwic29tZSIsIm9wdGltaXplIiwiTGltaXRDaHVua0NvdW50UGx1Z2luIiwibWF4Q2h1bmtzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBREE7QUFHQSxTQUFTQSxNQUFULENBQWdCQyxLQUFoQixFQUF1QjtBQUFBLE1BQ2JDLE9BRGEsR0FDY0QsS0FEZCxDQUNiQyxPQURhO0FBQUEsTUFDSkMsTUFESSxHQUNjRixLQURkLENBQ0pFLE1BREk7QUFBQSxNQUNJQyxLQURKLEdBQ2NILEtBRGQsQ0FDSUcsS0FESjtBQUFBLHNCQUU2QkQsTUFBTSxDQUFDRSxLQUZwQztBQUFBLE1BRWJDLElBRmEsaUJBRWJBLElBRmE7QUFBQSxNQUVQQyxJQUZPLGlCQUVQQSxJQUZPO0FBQUEsTUFFREMsWUFGQyxpQkFFREEsWUFGQztBQUFB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cGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IENhc2VTZW5zaXRpdmVQYXRoc1BsdWdpbiBmcm9tICdjYXNlLXNlbnNpdGl2ZS1wYXRocy13ZWJwYWNrLXBsdWdpbidcbmltcG9ydCB7IEJ1bmRsZUFuYWx5emVyUGx1Z2luIH0gZnJvbSAnd2VicGFjay1idW5kbGUtYW5hbHl6ZXInXG5pbXBvcnQgVGVyc2VyUGx1Z2luIGZyb20gJ3RlcnNlci13ZWJwYWNrLXBsdWdpbidcbmltcG9ydCBub2RlRXh0ZXJuYWxzIGZyb20gJ3dlYnBhY2stbm9kZS1leHRlcm5hbHMnXG5pbXBvcnQgRXh0cmFjdENzc0NodW5rcyBmcm9tICdleHRyYWN0LWNzcy1jaHVua3Mtd2VicGFjay1wbHVnaW4nXG5pbXBvcnQgT3B0aW1pemVDU1NBc3NldHNQbHVnaW4gZnJvbSAnb3B0aW1pemUtY3NzLWFzc2V0cy13ZWJwYWNrLXBsdWdpbidcbmltcG9ydCByZXNvbHZlRnJvbSBmcm9tICdyZXNvbHZlLWZyb20nXG4vL1xuaW1wb3J0IHJ1bGVzIGZyb20gJy4vcnVsZXMnXG5cbmZ1bmN0aW9uIGNvbW1vbihzdGF0ZSkge1xuICBjb25zdCB7IGFuYWx5emUsIGNvbmZpZywgZGVidWcgfSA9IHN0YXRlXG4gIGNvbnN0IHsgUk9PVCwgRElTVCwgTk9ERV9NT0RVTEVTLCBTUkMsIEFTU0VUUyB9ID0gY29uZmlnLnBhdGhzXG5cbiAgcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX0VOVFJZX1BBVEggPSBjb25maWcuZW50cnlcbiAgcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX1NJVEVfUk9PVCA9IGNvbmZpZy5zaXRlUm9vdFxuICBwcm9jZXNzLmVudi5SRUFDVF9TVEFUSUNfQkFTRV9QQVRIID0gY29uZmlnLmJhc2VQYXRoXG4gIHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19QVUJMSUNfUEFUSCA9IGNvbmZpZy5wdWJsaWNQYXRoXG4gIHByb2Nlc3MuZW52LlJFQUNUX1NUQVRJQ19BU1NFVFNfUEFUSCA9IGNvbmZpZy5hc3NldHNQYXRoXG5cbiAgaWYgKCFESVNULnN0YXJ0c1dpdGgoUk9PVCkpIHtcbiAgICAvLyB3ZSBidWlsZCBvdXRzaWRlIG9mIHByb2plY3QgZGlyLCBzbyByZXNldCBzb21lIHBhdGhzXG4gICAgcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX0FTU0VUU19QQVRIID0gY29uZmlnLmFzc2V0c1BhdGgucmVwbGFjZShESVNULCAnJylcbiAgfVxuXG4gIGNvbnN0IHNwbGl0Q2h1bmtzID0ge1xuICAgIGNodW5rczogJ2FsbCcsXG4gICAgbWluU2l6ZTogMTAwMDAsXG4gICAgbWluQ2h1bmtzOiAxLFxuICAgIG1heEFzeW5jUmVxdWVzdHM6IDUsXG4gICAgbWF4SW5pdGlhbFJlcXVlc3RzOiA1LFxuICAgIGF1dG9tYXRpY05hbWVEZWxpbWl0ZXI6ICd+JyxcbiAgICBuYW1lOiB0cnVlLFxuICAgIGNhY2hlR3JvdXBzOiB7XG4gICAgICB2ZW5kb3JzOiB7XG4gICAgICAgIHRlc3Q6IC9bXFxcXC9dbm9kZV9tb2R1bGVzW1xcXFwvXS8sXG4gICAgICAgIHByaW9yaXR5OiAtMTAsXG4gICAgICAgIGNodW5rczogJ2FsbCcsXG4gICAgICB9LFxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICBtaW5DaHVua3M6IDIsXG4gICAgICAgIHByaW9yaXR5OiAtMjAsXG4gICAgICAgIHJldXNlRXhpc3RpbmdDaHVuazogdHJ1ZSxcbiAgICAgIH0sXG4gICAgfSxcbiAgfVxuXG4gIGxldCBleHRyYWNrQ1NTQ2h1bmtzID0gbmV3IEV4dHJhY3RDc3NDaHVua3Moe1xuICAgIGZpbGVuYW1lOiAnW25hbWVdLltjaHVua0hhc2g6OF0uY3NzJyxcbiAgICBjaHVua0ZpbGVuYW1lOiAnW2lkXS5bY2h1bmtIYXNoOjhdLmNzcycsXG4gIH0pXG5cbiAgaWYgKCFjb25maWcuZXh0cmFjdENzc0NodW5rcykge1xuICAgIHNwbGl0Q2h1bmtzLmNhY2hlR3JvdXBzID0ge1xuICAgICAgc3R5bGVzOiB7XG4gICAgICAgIG5hbWU6ICdzdHlsZXMnLFxuICAgICAgICB0ZXN0OiAvXFwuY3NzJC8sXG4gICAgICAgIGNodW5rczogJ2FsbCcsXG4gICAgICAgIGVuZm9yY2U6IHRydWUsXG4gICAgICB9LFxuICAgIH1cbiAgICBleHRyYWNrQ1NTQ2h1bmtzID0gbmV3IEV4dHJhY3RDc3NDaHVua3Moe1xuICAgICAgZmlsZW5hbWU6ICdbbmFtZV0uW2NodW5rSGFzaDo4XS5jc3MnLFxuICAgIH0pXG4gIH1cblxuICByZXR1cm4ge1xuICAgIG1vZGU6ICdwcm9kdWN0aW9uJyxcbiAgICBjb250ZXh0OiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vLi4vLi4vbm9kZV9tb2R1bGVzJyksXG4gICAgZW50cnk6IGNvbmZpZy5kaXNhYmxlUnVudGltZVxuICAgICAgPyBjb25maWcuZW50cnlcbiAgICAgIDogW1xuICAgICAgICAgIHJlcXVpcmUucmVzb2x2ZSgnLi4vLi4vYm9vdHN0cmFwUGx1Z2lucycpLFxuICAgICAgICAgIHJlcXVpcmUucmVzb2x2ZSgnLi4vLi4vYm9vdHN0cmFwVGVtcGxhdGVzJyksXG4gICAgICAgICAgcmVxdWlyZS5yZXNvbHZlKCcuLi8uLi9ib290c3RyYXBBcHAnKSxcbiAgICAgICAgXSxcbiAgICBvdXRwdXQ6IHtcbiAgICAgIGZpbGVuYW1lOiAnW25hbWVdLltoYXNoOjhdLmpzJywgLy8gZG9udCB1c2UgY2h1bmtoYXNoLCBpdHMgbm90IGEgY2h1bmtcbiAgICAgIGNodW5rRmlsZW5hbWU6ICd0ZW1wbGF0ZXMvW25hbWVdLltjaHVua0hhc2g6OF0uanMnLFxuICAgICAgcGF0aDogQVNTRVRTLFxuICAgICAgcHVibGljUGF0aDogcHJvY2Vzcy5lbnYuUkVBQ1RfU1RBVElDX0FTU0VUU19QQVRIIHx8ICcvJyxcbiAgICB9LFxuICAgIG9wdGltaXphdGlvbjoge1xuICAgICAgc2lkZUVmZmVjdHM6IHRydWUsXG4gICAgICBtaW5pbWl6ZTogdHJ1ZSxcbiAgICAgIG1pbmltaXplcjogW1xuICAgICAgICBuZXcgVGVyc2VyUGx1Z2luKHtcbiAgICAgICAgICBjYWNoZTogdHJ1ZSxcbiAgICAgICAgICBwYXJhbGxlbDogdHJ1ZSxcbiAgICAgICAgICBleGNsdWRlOiAvXFwubWluXFwuanMvLFxuICAgICAgICAgIC4uLmNvbmZpZy50ZXJzZXIsXG4gICAgICAgICAgc291cmNlTWFwOlxuICAgICAgICAgICAgY29uZmlnLnByb2R1Y3Rpb25Tb3VyY2VNYXBzIHx8IGNvbmZpZy50ZXJzZXIuc291cmNlTWFwIHx8IGRlYnVnLFxuICAgICAgICAgIHRlcnNlck9wdGlvbnM6IHtcbiAgICAgICAgICAgIGllODogZmFsc2UsXG4gICAgICAgICAgICAuLi5jb25maWcudGVyc2VyLnRlcnNlck9wdGlvbnMsXG4gICAgICAgICAgICBtYW5nbGU6IHsgc2FmYXJpMTA6IHRydWUsIC4uLmNvbmZpZy50ZXJzZXIudGVyc2VyT3B0aW9ucy5tYW5nbGUgfSxcbiAgICAgICAgICAgIHBhcnNlOiB7IGVjbWE6IDgsIC4uLmNvbmZpZy50ZXJzZXIudGVyc2VyT3B0aW9ucy5wYXJzZSB9LFxuICAgICAgICAgICAgY29tcHJlc3M6IHsgZWNtYTogNSwgLi4uY29uZmlnLnRlcnNlci50ZXJzZXJPcHRpb25zLmNvbXByZXNzIH0sXG4gICAgICAgICAgICBvdXRwdXQ6IHsgZWNtYTogNSwgLi4uY29uZmlnLnRlcnNlci50ZXJzZXJPcHRpb25zLm91dHB1dCB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgICBuZXcgT3B0aW1pemVDU1NBc3NldHNQbHVnaW4oe30pLFxuICAgICAgXSxcbiAgICAgIHNwbGl0Q2h1bmtzLFxuICAgIH0sXG4gICAgcGVyZm9ybWFuY2U6IHtcbiAgICAgIG1heEVudHJ5cG9pbnRTaXplOiAzMDAwMDAsXG4gICAgfSxcbiAgICBtb2R1bGU6IHtcbiAgICAgIHJ1bGVzOiBydWxlcyh7IGNvbmZpZywgc3RhZ2U6ICdwcm9kJywgaXNOb2RlOiBmYWxzZSB9KSxcbiAgICAgIHN0cmljdEV4cG9ydFByZXNlbmNlOiB0cnVlLFxuICAgIH0sXG4gICAgcmVzb2x2ZToge1xuICAgICAgbW9kdWxlczogW1xuICAgICAgICBOT0RFX01PRFVMRVMsXG4gICAgICAgIFNSQyxcbiAgICAgICAgRElTVCxcbiAgICAgICAgLi4uW05PREVfTU9EVUxFUywgU1JDLCBESVNUXS5tYXAoZCA9PlxuICAgICAgICAgIERJU1Quc3RhcnRzV2l0aChST09UKSA/IHBhdGgucmVsYXRpdmUoX19kaXJuYW1lLCBkKSA6IHBhdGgucmVzb2x2ZShkKVxuICAgICAgICApLFxuICAgICAgICAnbm9kZV9tb2R1bGVzJyxcbiAgICAgIF0sXG4gICAgICBleHRlbnNpb25zOiBbJy53YXNtJywgJy5tanMnLCAnLmpzJywgJy5qc29uJywgJy5qc3gnXSxcbiAgICAgIGFsaWFzOiB7XG4gICAgICAgIHJlYWN0OiByZXNvbHZlRnJvbShjb25maWcucGF0aHMuTk9ERV9NT0RVTEVTLCAncmVhY3QnKSxcbiAgICAgICAgJ3JlYWN0LWRvbSc6IHJlc29sdmVGcm9tKGNvbmZpZy5wYXRocy5OT0RFX01PRFVMRVMsICdyZWFjdC1kb20nKSxcbiAgICAgICAgJ3JlYWN0LXVuaXZlcnNhbC1jb21wb25lbnQnOiByZXNvbHZlRnJvbShcbiAgICAgICAgICBfX2Rpcm5hbWUsXG4gICAgICAgICAgJ3JlYWN0LXVuaXZlcnNhbC1jb21wb25lbnQnXG4gICAgICAgICksXG4gICAgICB9LFxuICAgIH0sXG4gICAgZXh0ZXJuYWxzOiBbXSxcbiAgICB0YXJnZXQ6IHVuZGVmaW5lZCxcbiAgICBwbHVnaW5zOiBbXG4gICAgICBuZXcgd2VicGFjay5FbnZpcm9ubWVudFBsdWdpbihwcm9jZXNzLmVudiksXG4gICAgICBleHRyYWNrQ1NTQ2h1bmtzLFxuICAgICAgbmV3IENhc2VTZW5zaXRpdmVQYXRoc1BsdWdpbigpLFxuICAgICAgYW5hbHl6ZSAmJiBuZXcgQnVuZGxlQW5hbHl6ZXJQbHVnaW4oKSxcbiAgICBdLmZpbHRlcihkID0+IGQpLFxuICAgIGRldnRvb2w6IGRlYnVnIHx8IGNvbmZpZy5wcm9kdWN0aW9uU291cmNlTWFwcyA/ICdzb3VyY2UtbWFwJyA6IGZhbHNlLFxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKHN0YXRlKSB7XG4gIGNvbnN0IHtcbiAgICBzdGFnZSxcbiAgICBjb25maWc6IHsgcGF0aHMgfSxcbiAgfSA9IHN0YXRlXG5cbiAgY29uc3QgcmVzdWx0ID0gY29tbW9uKHN0YXRlKVxuICBpZiAoc3RhZ2UgIT09ICdub2RlJykgcmV0dXJuIHJlc3VsdFxuXG4gIC8vIE5vZGUgb25seSEhIVxuICByZXN1bHQub3V0cHV0LmZpbGVuYW1lID0gJ3N0YXRpYy1hcHAuanMnXG4gIHJlc3VsdC5vdXRwdXQucGF0aCA9IHBhdGhzLkFSVElGQUNUU1xuICByZXN1bHQub3V0cHV0LmxpYnJhcnlUYXJnZXQgPSAndW1kJ1xuICByZXN1bHQub3B0aW1pemF0aW9uLm1pbmltaXplID0gZmFsc2VcbiAgcmVzdWx0Lm9wdGltaXphdGlvbi5taW5pbWl6ZXIgPSBbXVxuICByZXN1bHQudGFyZ2V0ID0gJ25vZGUnXG4gIHJlc3VsdC5kZXZ0b29sID0gZmFsc2VcbiAgcmVzdWx0LmV4dGVybmFscyA9IFtcbiAgICBuZXcgUmVnRXhwKGAke3BhdGhzLlBMVUdJTlN9YCksXG4gICAgKGNvbnRleHQsIHJlcXVlc3QsIGNhbGxiYWNrKSA9PiB7XG4gICAgICBjb25zdCByZXNvbHZlZCA9IHBhdGgucmVzb2x2ZShjb250ZXh0LCByZXF1ZXN0KVxuICAgICAgaWYgKFxuICAgICAgICBbL3JlYWN0LXN0YXRpYyhcXFxcfFxcLylsaWIoXFxcXHxcXC8pYnJvd3Nlci8sIC93ZWJwYWNrLWZsdXNoLWNodW5rcy9dLnNvbWUoXG4gICAgICAgICAgZCA9PiBkLnRlc3QocmVzb2x2ZWQpXG4gICAgICAgIClcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gY2FsbGJhY2sobnVsbCwgYGNvbW1vbmpzICR7cmVzb2x2ZWR9YClcbiAgICAgIH1cbiAgICAgIGNhbGxiYWNrKClcbiAgICB9LFxuICAgIG5vZGVFeHRlcm5hbHMoKSxcbiAgXVxuICByZXN1bHQubW9kdWxlLnJ1bGVzID0gcnVsZXMoc3RhdGUpXG4gIHJlc3VsdC5wbHVnaW5zID0gW1xuICAgIG5ldyB3ZWJwYWNrLkVudmlyb25tZW50UGx1Z2luKHByb2Nlc3MuZW52KSxcbiAgICBuZXcgQ2FzZVNlbnNpdGl2ZVBhdGhzUGx1Z2luKCksXG4gICAgbmV3IHdlYnBhY2sub3B0aW1pemUuTGltaXRDaHVua0NvdW50UGx1Z2luKHtcbiAgICAgIG1heENodW5rczogMSxcbiAgICB9KSxcbiAgXVxuICByZXR1cm4gcmVzdWx0XG59XG4iXX0=